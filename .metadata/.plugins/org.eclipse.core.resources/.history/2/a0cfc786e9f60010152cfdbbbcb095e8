package com.inventory.service;

import com.inventory.dto.request.ProductRequest;
import com.inventory.dto.response.ProductResponse;
import com.inventory.entity.*;
import com.inventory.exception.BadRequestException;
import com.inventory.exception.ResourceNotFoundException;
import com.inventory.repository.*;
import com.inventory.security.SecurityUtils;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.*;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class ProductService {

    private final ProductRepository products;
    private final ProductSupplierRepository productSuppliers;
    private final CategoryRepository categories;
    private final SupplierRepository suppliers;
    private final SecurityUtils securityUtils;

    @Transactional(readOnly = true)
    public Page<ProductResponse> getAll(Pageable pageable) {
        User user = securityUtils.getCurrentUser();

        // 1. FILTER: Inventory Staff sees ONLY their Department
        if (user.getRole().getName().equals("INVENTORY_STAFF")) {
            String dept = user.getDepartment();
            if (dept != null && !dept.isEmpty()) {
                return products.findByCategoryName(dept, pageable).map(this::toResponse);
            }
        }

        // 2. Admin/Sales see ALL ACTIVE products (Paginated)
        return products.findByIsActiveTrue(pageable).map(this::toResponse);
    }

    @Transactional(readOnly = true)
    public Page<ProductResponse> search(String q, Pageable pageable) {
        User user = securityUtils.getCurrentUser();

        // 1. FILTER: Inventory Staff searches ONLY their Department
        if (user.getRole().getName().equals("INVENTORY_STAFF")) {
            String dept = user.getDepartment();
            if (dept != null && !dept.isEmpty()) {
                return products.searchByCategoryName(dept, q, pageable).map(this::toResponse);
            }
        }

        // 2. Admin/Sales search ALL
        return products.searchProducts(q, pageable).map(this::toResponse);
    }

    @Transactional(readOnly = true)
    public ProductResponse get(Long id) {
        Product p = products.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Product not found: " + id));
        return toResponse(p);
    }

    @Transactional(readOnly = true)
    public List<ProductResponse> lowStock() {
        return products.findLowStockProducts().stream().map(this::toResponse).toList();
    }

    @Transactional(readOnly = true)
    public List<ProductResponse> getExpiredProducts() {
        return products.findExpiredProducts().stream().map(this::toResponse).toList();
    }

    @Transactional
    public ProductResponse create(ProductRequest req) {
        if (products.existsBySku(req.getSku())) {
            throw new BadRequestException("Product with SKU already exists: " + req.getSku());
        }

        User me = securityUtils.getCurrentUser();

        Product p = Product.builder()
                .sku(req.getSku())
                .name(req.getName())
                .description(req.getDescription())
                .unitPrice(req.getUnitPrice())
                .costPrice(req.getCostPrice())
                .quantityOnHand(req.getQuantityOnHand() != null ? req.getQuantityOnHand() : 0)
                .reorderPoint(req.getReorderPoint() != null ? req.getReorderPoint() : 10)
                .reorderQuantity(req.getReorderQuantity() != null ? req.getReorderQuantity() : 50)
                .autoReorderEnabled(req.getAutoReorderEnabled() != null ? req.getAutoReorderEnabled() : false)
                .expiryDate(req.getExpiryDate())
                .unitOfMeasure(req.getUnitOfMeasure() != null ? req.getUnitOfMeasure() : "UNIT")
                .location(req.getLocation())
                .barcode(req.getBarcode())
                .imageUrl(req.getImageUrl())
                .isActive(true)
                .createdBy(me)
                .build();

        if (req.getCategoryId() != null) {
            Category c = categories.findById(req.getCategoryId())
                    .orElseThrow(() -> new ResourceNotFoundException("Category not found"));
            p.setCategory(c);
        }

        p.getProductSuppliers().clear();
        p.getProductSuppliers().addAll(buildSupplierLinks(p, req.getSupplierIds()));

        p = products.save(p);
        return toResponse(p);
    }

    @Transactional
    public ProductResponse update(Long id, ProductRequest req) {
        Product p = products.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Product not found: " + id));

        if (!p.getSku().equals(req.getSku()) && products.existsBySku(req.getSku())) {
            throw new BadRequestException("Product with SKU already exists: " + req.getSku());
        }

        p.setSku(req.getSku());
        p.setName(req.getName());
        p.setDescription(req.getDescription());
        p.setUnitPrice(req.getUnitPrice());
        p.setCostPrice(req.getCostPrice());
        p.setReorderPoint(req.getReorderPoint());
        p.setReorderQuantity(req.getReorderQuantity());
        p.setExpiryDate(req.getExpiryDate());
        p.setUnitOfMeasure(req.getUnitOfMeasure());
        p.setLocation(req.getLocation());
        p.setBarcode(req.getBarcode());
        p.setImageUrl(req.getImageUrl());
        
        if (req.getAutoReorderEnabled() != null) {
            p.setAutoReorderEnabled(req.getAutoReorderEnabled());
        }

        if (req.getCategoryId() != null) {
            Category c = categories.findById(req.getCategoryId())
                    .orElseThrow(() -> new ResourceNotFoundException("Category not found"));
            p.setCategory(c);
        } else {
            p.setCategory(null);
        }

        p.getProductSuppliers().clear();
        p.getProductSuppliers().addAll(buildSupplierLinks(p, req.getSupplierIds()));

        p = products.save(p);
        return toResponse(p);
    }

    @Transactional
    public void delete(Long id) {
        Product p = products.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Product not found: " + id));
        p.setIsActive(false);
        products.save(p);
    }

    private Set<ProductSupplier> buildSupplierLinks(Product product, Set<Long> supplierIds) {
        if (supplierIds == null || supplierIds.isEmpty()) return Set.of();

        List<Supplier> found = suppliers.findAllById(supplierIds);
        if (found.size() != supplierIds.size()) {
            throw new BadRequestException("One or more supplierIds are invalid");
        }

        return found.stream()
                .map(s -> ProductSupplier.builder()
                        .product(product)
                        .supplier(s)
                        .leadTimeDays(7)
                        .isPreferred(false)
                        .build())
                .collect(Collectors.toSet());
    }

    private ProductResponse toResponse(Product p) {
        List<ProductResponse.SupplierInfo> supplierInfos =
                p.getProductSuppliers().stream()
                        .map(ps -> ProductResponse.SupplierInfo.builder()
                                .id(ps.getSupplier().getId())
                                .name(ps.getSupplier().getName())
                                .contactPerson(ps.getSupplier().getContactPerson())
                                .build())
                        .toList();

        return ProductResponse.builder()
                .id(p.getId())
                .sku(p.getSku())
                .name(p.getName())
                .description(p.getDescription())
                .categoryId(p.getCategory() != null ? p.getCategory().getId() : null)
                .categoryName(p.getCategory() != null ? p.getCategory().getName() : null)
                .unitPrice(p.getUnitPrice())
                .costPrice(p.getCostPrice())
                .quantityOnHand(p.getQuantityOnHand())
                .reorderPoint(p.getReorderPoint())
                .reorderQuantity(p.getReorderQuantity())
                .autoReorderEnabled(p.getAutoReorderEnabled())
                .expiryDate(p.getExpiryDate())
                .isExpired(p.isExpired())
                .unitOfMeasure(p.getUnitOfMeasure())
                .location(p.getLocation())
                .barcode(p.getBarcode())
                .imageUrl(p.getImageUrl())
                .isActive(p.getIsActive())
                .isLowStock(p.isLowStock())
                .totalValue(p.getTotalValue())
                .suppliers(supplierInfos)
                .createdAt(p.getCreatedAt())
                .updatedAt(p.getUpdatedAt())
                .build();
    }
}