package com.inventory.repository;

import com.inventory.entity.Product;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.*;
import org.springframework.data.repository.query.Param;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

public interface ProductRepository extends JpaRepository<Product, Long>, JpaSpecificationExecutor<Product> {

    // ... existing basic methods ...
    Optional<Product> findBySku(String sku);
    boolean existsBySku(String sku);
    List<Product> findByIsActiveTrue();
    
    // ... existing analytics queries ...
    @Query("SELECT p FROM Product p WHERE p.isActive = true AND p.quantityOnHand <= p.reorderPoint")
    List<Product> findLowStockProducts();

    // --- NEW QUERY 1: Expiring Soon (Next 30 Days) ---
    @Query("SELECT p FROM Product p WHERE p.isActive = true AND p.expiryDate BETWEEN :today AND :thirtyDaysLater ORDER BY p.expiryDate ASC")
    List<Product> findExpiringSoon(@Param("today") LocalDate today, @Param("thirtyDaysLater") LocalDate thirtyDaysLater);

    // --- NEW QUERY 2: Dead Stock (No Sales in X Days) ---
    @Query("""
        SELECT p FROM Product p 
        WHERE p.isActive = true 
        AND p.quantityOnHand > 0
        AND p.id NOT IN (
            SELECT DISTINCT i.product.id 
            FROM SalesOrderItem i 
            JOIN i.salesOrder o 
            WHERE o.orderDate >= :cutoffDate 
            AND o.status <> com.inventory.entity.SalesOrder$OrderStatus.CANCELLED
        )
    """)
    List<Product> findDeadStock(@Param("cutoffDate") LocalDateTime cutoffDate, Pageable pageable);

    // ... rest of existing methods ...
}