package com.inventory.repository;

import com.inventory.entity.SalesOrder;
import org.springframework.data.domain.*;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

public interface SalesOrderRepository extends JpaRepository<SalesOrder, Long> {

    @EntityGraph(attributePaths = {"items", "items.product", "customer", "createdBy", "updatedBy"})
    Page<SalesOrder> findAll(Pageable pageable);

    @EntityGraph(attributePaths = {"items", "items.product", "customer", "createdBy", "updatedBy"})
    Optional<SalesOrder> findById(Long id);

    @EntityGraph(attributePaths = {"items", "items.product", "customer"})
    List<SalesOrder> findByOrderDateBetween(LocalDateTime startDate, LocalDateTime endDate);

    @EntityGraph(attributePaths = {"items", "items.product", "customer"})
    List<SalesOrder> findTop10ByOrderByOrderDateDesc();

    @Query("""
        SELECT COUNT(so) FROM SalesOrder so
        WHERE so.orderDate >= :start
          AND so.status <> com.inventory.entity.SalesOrder$OrderStatus.CANCELLED
    """)
    Integer countNonCancelledSince(@Param("start") LocalDateTime start);

    @Query("""
        SELECT COALESCE(SUM(so.totalAmount), 0) FROM SalesOrder so
        WHERE so.orderDate >= :start
          AND so.status <> com.inventory.entity.SalesOrder$OrderStatus.CANCELLED
    """)
    BigDecimal sumRevenueSince(@Param("start") LocalDateTime start);

    // Daily Aggregation
    @Query("""
        SELECT 
            CAST(so.orderDate AS LocalDate) as date, 
            COUNT(so) as count, 
            SUM(so.totalAmount) as revenue 
        FROM SalesOrder so 
        WHERE so.orderDate >= :startDate 
          AND so.status <> com.inventory.entity.SalesOrder$OrderStatus.CANCELLED
        GROUP BY CAST(so.orderDate AS LocalDate)
        ORDER BY date ASC
    """)
    List<Object[]> findSalesStatsByDateRange(@Param("startDate") LocalDateTime startDate);

    // Monthly Aggregation (Safe for H2 and MySQL)
    @Query("""
        SELECT 
            YEAR(so.orderDate) as y, 
            MONTH(so.orderDate) as m, 
            COUNT(so) as count, 
            SUM(so.totalAmount) as revenue 
        FROM SalesOrder so 
        WHERE so.orderDate >= :startDate 
          AND so.status <> com.inventory.entity.SalesOrder$OrderStatus.CANCELLED
        GROUP BY YEAR(so.orderDate), MONTH(so.orderDate)
        ORDER BY y ASC, m ASC
    """)
    List<Object[]> findSalesStatsByMonth(@Param("startDate") LocalDateTime startDate);

    @Query("""
        SELECT 
            COALESCE(u.department, 'Unassigned') as dept, 
            SUM(so.totalAmount) as total 
        FROM SalesOrder so 
        JOIN so.createdBy u 
        WHERE so.status <> com.inventory.entity.SalesOrder$OrderStatus.CANCELLED
        GROUP BY u.department
    """)
    List<Object[]> findSalesByDepartment();
}