package com.inventory.service;

import com.inventory.dto.request.AdminUserCreateRequest;
import com.inventory.dto.request.AdminUserUpdateRequest;
import com.inventory.entity.Role;
import com.inventory.entity.User;
import com.inventory.exception.BadRequestException;
import com.inventory.exception.ResourceNotFoundException;
import com.inventory.exception.UnauthorizedException;
import com.inventory.repository.RoleRepository;
import com.inventory.repository.UserRepository;
import com.inventory.security.SecurityUtils;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.*;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@RequiredArgsConstructor
public class UserService {

    private final UserRepository users;
    private final RoleRepository roles;
    private final PasswordEncoder encoder;
    private final SecurityUtils securityUtils;

    // --- ADMIN METHODS ---

    @Transactional(readOnly = true)
    public Page<User> getAll(Pageable pageable) {
        return users.findAll(pageable);
    }

    @Transactional(readOnly = true)
    public User getById(Long id) {
        return users.findById(id).orElseThrow(() -> new ResourceNotFoundException("User not found: " + id));
    }

    @Transactional(readOnly = true)
    public List<User> getByRole(String roleName) {
        return users.findByRoleName(roleName);
    }

    @Transactional
    public User create(AdminUserCreateRequest req) {
        Role role = roles.findById(req.getRoleId())
                .orElseThrow(() -> new BadRequestException("Invalid roleId"));

        // --- SINGLE ADMIN CONSTRAINT ---
        if (role.getName().equals("ADMIN")) {
            long adminCount = users.findByRoleName("ADMIN").size();
            if (adminCount >= 1) {
                throw new BadRequestException("System policy allows only one Admin. Cannot create another.");
            }
        }

        if (users.existsByEmail(req.getEmail())) {
            throw new BadRequestException("Email already exists");
        }

        User u = User.builder()
                .email(req.getEmail())
                .passwordHash(encoder.encode(req.getPassword()))
                .firstName(req.getFirstName())
                .lastName(req.getLastName())
                .phone(req.getPhone())
                .department(req.getDepartment())
                .role(role)
                .isActive(true)
                .emailVerified(false)
                .failedLoginAttempts(0)
                .lockedUntil(null)
                .build();

        return users.save(u);
    }

    @Transactional
    public User update(Long id, AdminUserUpdateRequest req) {
        User u = users.findById(id).orElseThrow(() -> new ResourceNotFoundException("User not found: " + id));

        if (!u.getEmail().equals(req.getEmail()) && users.existsByEmail(req.getEmail())) {
            throw new BadRequestException("Email already exists");
        }

        Role role = roles.findById(req.getRoleId())
                .orElseThrow(() -> new BadRequestException("Invalid roleId"));

        // Prevent changing own role away from Admin if it's the only one
        if (u.getRole().getName().equals("ADMIN") && !role.getName().equals("ADMIN")) {
             throw new BadRequestException("Cannot demote the only Admin.");
        }

        u.setEmail(req.getEmail());
        u.setFirstName(req.getFirstName());
        u.setLastName(req.getLastName());
        u.setPhone(req.getPhone());
        u.setDepartment(req.getDepartment());
        u.setRole(role);

        if (req.getPassword() != null && !req.getPassword().isBlank()) {
            u.setPasswordHash(encoder.encode(req.getPassword()));
        }

        return users.save(u);
    }

    @Transactional
    public void activate(Long id) {
        User u = users.findById(id).orElseThrow(() -> new ResourceNotFoundException("User not found: " + id));
        u.setIsActive(true);
        u.setFailedLoginAttempts(0);
        u.setLockedUntil(null);
        users.save(u);
    }

    @Transactional
    public void deactivate(Long id) {
        User u = users.findById(id).orElseThrow(() -> new ResourceNotFoundException("User not found: " + id));
        // Prevent deactivating the only Admin
        if (u.getRole().getName().equals("ADMIN")) {
            throw new BadRequestException("Cannot deactivate the System Admin.");
        }
        u.setIsActive(false);
        users.save(u);
    }

    @Transactional
    public void softDelete(Long id) {
        deactivate(id);
    }

    // --- INVENTORY STAFF METHODS (Team Management) ---

    @Transactional(readOnly = true)
    public List<User> getMyTeam() {
        User manager = securityUtils.getCurrentUser();
        // Returns users managed by the current logged-in Inventory Staff
        return users.findByManagerId(manager.getId());
    }

    @Transactional
    public User createTeamMember(AdminUserCreateRequest req) {
        User manager = securityUtils.getCurrentUser();
        
        // Ensure limit of 4 members
        List<User> team = users.findByManagerId(manager.getId());
        if (team.size() >= 4) {
            throw new BadRequestException("Team limit reached (Max 4 members).");
        }

        if (users.existsByEmail(req.getEmail())) throw new BadRequestException("Email exists");

        Role salesRole = roles.findByName("SALES_EXECUTIVE")
                .orElseThrow(() -> new BadRequestException("Sales role configuration error"));

        User u = User.builder()
                .email(req.getEmail())
                .passwordHash(encoder.encode(req.getPassword()))
                .firstName(req.getFirstName())
                .lastName(req.getLastName())
                .phone(req.getPhone())
                .department(manager.getDepartment()) // Inherit Manager's Department
                .role(salesRole) // Forced to Sales Executive
                .manager(manager) // Link to Manager
                .isActive(true)
                .build();

        return users.save(u);
    }

    @Transactional
    public User updateTeamMember(Long id, AdminUserUpdateRequest req) {
        User manager = securityUtils.getCurrentUser();
        User member = users.findById(id).orElseThrow(() -> new ResourceNotFoundException("Member not found"));

        // Security Check: Ensure this member belongs to this manager
        if (member.getManager() == null || !member.getManager().getId().equals(manager.getId())) {
            throw new UnauthorizedException("You can only manage your own team members.");
        }

        member.setFirstName(req.getFirstName());
        member.setLastName(req.getLastName());
        member.setEmail(req.getEmail());
        member.setPhone(req.getPhone());
        
        if (req.getPassword() != null && !req.getPassword().isBlank()) {
            member.setPasswordHash(encoder.encode(req.getPassword()));
        }

        return users.save(member);
    }

    @Transactional
    public void deleteTeamMember(Long id) {
        User manager = securityUtils.getCurrentUser();
        User member = users.findById(id).orElseThrow(() -> new ResourceNotFoundException("Member not found"));

        if (member.getManager() == null || !member.getManager().getId().equals(manager.getId())) {
            throw new UnauthorizedException("You can only delete your own team members.");
        }

        member.setIsActive(false); // Soft delete
        users.save(member);
    }
}